{% extends "base.html" %}
{% block title %}Clientes{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">

<div class="d-flex justify-content-between align-items-center mb-3">   
    <div>
        <h2><i class="bi bi-people"></i> Clientes</h2>
        <span class="badge bg-primary">{{ qtd_clientes }} Clientes encontrados</span>
    </div>
    <button id="meuBotao" class="w3-btn w3-blue w3-xlarge w3-circle w3-card-2"><i class="fa fa-plus"></i></button>
</div>

<div class="card">
    <div class="card-body">
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Cobrador</th>
                    <th>Tel</th>
                    <th>Endereço</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                {% for cliente in clientes %}
                <tr>
                    <td>{{ cliente.id }}</td>
                    <td>{{ cliente.nome }}</td>
                    <td>{{ cliente.cobrador.usuario|capitalize }}</td>
                    <td>
                        {% if cliente.telefone %}
                            {% set tel_limpo = cliente.telefone | replace('+','') | replace('(','') | replace(')','') | replace(' ','') | replace('-','') %}
                            <a href="https://wa.me//{{ tel_limpo }}" target="_blank">{{ cliente.telefone }}</a>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>{{ cliente.endereco }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning"
                            data-bs-toggle="modal"
                            data-bs-target="#modalEditarCliente"
                            data-id="{{ cliente.id }}"
                            data-nome="{{ cliente.nome }}"
                            data-telefone="{{ cliente.telefone }}"
                            data-endereco="{{ cliente.endereco }}">
                            ✏️ Editar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL EDITAR CLIENTE -->
<div class="modal fade" id="modalEditarCliente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form method="POST" id="form-editar-cliente">
        <div class="modal-header">
          <h5 class="modal-title">Editar Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="id" id="cliente-id" readonly>

          <div class="mb-3">
            <label class="form-label">Nome</label>
            <input type="text" class="form-control" id="cliente-nome" name="nome" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Telefone</label>
            <input type="text" class="form-control" id="cliente-telefone" name="telefone">
          </div>
          <div class="mb-3">
            <label class="form-label">Endereço</label>
            <input type="text" class="form-control" id="cliente-endereco" name="endereco">
          </div>
        </div>

        <div class="modal-footer d-flex justify-content-between align-items-center">
          <a id="btn-excluir-cliente" href="#" 
             onclick="return confirm('Tem certeza que deseja excluir este cliente?')" 
             class="btn btn-sm btn-outline-danger">Excluir Cliente</a>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- PAGINAÇÃO -->
<nav aria-label="Navegação de páginas" class="mt-3">
  <ul class="pagination justify-content-center">
    {% if pagination.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('listar_clientes', page=pagination.prev_num) }}">Anterior</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Anterior</span></li>
    {% endif %}

    {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if p %}
        {% if p == pagination.page %}
          <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="{{ url_for('listar_clientes', page=p) }}">{{ p }}</a></li>
        {% endif %}
      {% else %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
      {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('listar_clientes', page=pagination.next_num) }}">Próximo</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Próximo</span></li>
    {% endif %}
  </ul>
</nav>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // --- Abrir modal de edição ---
  const modalCliente = document.getElementById('modalEditarCliente');
  modalCliente.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;

      const clienteId = button.getAttribute('data-id');
      const clienteNome = button.getAttribute('data-nome');
      const clienteTelefone = button.getAttribute('data-telefone');
      const clienteEndereco = button.getAttribute('data-endereco');

      document.getElementById('cliente-id').value = clienteId;
      document.getElementById('cliente-nome').value = clienteNome;
      document.getElementById('cliente-telefone').value = clienteTelefone;
      document.getElementById('cliente-endereco').value = clienteEndereco;

      // Atualiza o action do form e do botão Excluir
      document.getElementById('form-editar-cliente').action = `/editar_cliente/${clienteId}`;
      document.getElementById('btn-excluir-cliente').href = `/excluir_cliente/${clienteId}`;
  });

  // --- Botão adicionar cliente ---
  const meuBotao = document.getElementById('meuBotao');
  meuBotao.addEventListener('click', function(){
      window.location.href = '/cadastro_cliente';
  });

  // ======== MÁSCARA DE TELEFONE NO MODAL EDITAR ========
    const telefoneEditar = document.getElementById("cliente-telefone");

    telefoneEditar.placeholder = "+55 (__) _____-____";

    telefoneEditar.addEventListener("input", function (e) {
        let valor = e.target.value.replace(/\D/g, ""); // Remove tudo que não é número

        // Garante o +55 no início
        if (!valor.startsWith("55")) {
            valor = "55" + valor;
        }

        // Aplica a máscara gradualmente
        let formatado = "+";
        if (valor.length > 0) formatado += valor.substring(0, 2);
        if (valor.length > 2) formatado += " (" + valor.substring(2, 4);
        if (valor.length > 4) formatado += ") " + valor.substring(4, 9);
        if (valor.length > 9) formatado += "-" + valor.substring(9, 13);

        e.target.value = formatado;
    });

    telefoneEditar.addEventListener("focus", function () {
        if (!this.value) this.placeholder = "+55 (__) _____-____";
    });

    telefoneEditar.addEventListener("blur", function () {
        if (!this.value) this.placeholder = "+55 (__) _____-____";
    });
});
</script>
{% endblock %}
